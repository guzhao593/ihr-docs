(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{524:function(s,t,a){s.exports=a.p+"assets/img/GlobalGrants.9d0e539c.png"},688:function(s,t,a){"use strict";a.r(t);var n=a(30),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"表单权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#表单权限"}},[s._v("#")]),s._v(" 表单权限")]),s._v(" "),n("p",[s._v("依托于 "),n("code",[s._v("i-form-item")]),s._v(" 我们不需要逐个在表单项中的表单控件上绑定 "),n("code",[s._v("v-if/v-show")]),s._v("、"),n("code",[s._v("disabled")]),s._v(" 来实现隐藏和禁用，因为不仅 "),n("code",[s._v("i-form-item")]),s._v(" 提供了 "),n("code",[s._v("hidden/disabled")]),s._v(" 实现了同样的效果，而且 "),n("code",[s._v("i-form-x")]),s._v(" 更是提供了 "),n("code",[s._v("grants")]),s._v(" 字段用于全局接管 "),n("code",[s._v("i-form-item")]),s._v(" 的这两个属性。"),n("RouterLink",{attrs:{to:"/component/form.html#表单权限"}},[s._v("进一步了解")])],1),s._v(" "),n("h3",{attrs:{id:"问题"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),n("p",[s._v("在真实的业务场景中依然存在如下问题：")]),s._v(" "),n("ol",[n("li",[s._v("后端返回的权限数据并不一定与组件需要的一致，那就意味着需要一个统一的入口作为转换层")]),s._v(" "),n("li",[s._v("一般来说权限配置并不会由开发者显式地在代码中申明，不仅具备太强的侵入性，导致本身就很复杂的业务表单跟表单权限逻辑造成冗余，而且难以维护需要逐个请求和传递权限信息")])]),s._v(" "),n("h3",{attrs:{id:"方案"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#方案"}},[s._v("#")]),s._v(" 方案")]),s._v(" "),n("p",[s._v("我们如何做到兼顾如上的问题同时，让开发者对表单权限的逻辑无感知，让业务更纯粹呢？我们的实践方案是：表单权限信息由系统统一请求、转换、存储（全局状态："),n("code",[s._v("Vuex")]),s._v(" 或 "),n("code",[s._v("Vue")]),s._v(" 原型链等）。每个 "),n("code",[s._v("i-form-x")]),s._v(" 表单都显式地绑定 "),n("code",[s._v("code")]),s._v(" 编码作为唯一标示。初始化时组件会根据 "),n("code",[s._v("code")]),s._v(" 在全局状态中获取对应的权限配置，从而控制表单隐藏和禁用。")]),s._v(" "),n("p",[s._v("解决了什么问题：")]),s._v(" "),n("ol",[n("li",[s._v("在系统请求后执行数据转换，适配了后端接口和组件属性不匹配的问题")]),s._v(" "),n("li",[s._v("只需要绑定 "),n("code",[s._v("code")]),s._v(" 编码，以极低的“侵入性”实现业务和权限分离，不再需要开发者自行绑定对应的权限信息到 "),n("code",[s._v("grants/hidden/disabled")]),s._v("  字段")])]),s._v(" "),n("h3",{attrs:{id:"实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[s._v("#")]),s._v(" 实现")]),s._v(" "),n("p",[s._v("最终的目标就是实现「如何让表单自动获取存储在全局状态中的权限配置」。首先组件本身并不具备这样的业务能力，我们可以通过 "),n("code",[s._v("extends")]),s._v(" 或 "),n("code",[s._v("mixins")]),s._v(" 的形式将"),n("strong",[s._v("通用表单")]),s._v("拓展为"),n("strong",[s._v("适用于特定项目的通用表单")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" FormX "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  mixins"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Sahara"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Form"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("X")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ...拓展")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("我们知道 "),n("code",[s._v("i-form-x")]),s._v(" 会调用 "),n("code",[s._v("initGrants")]),s._v(" 将外界传入的 "),n("code",[s._v("grants")]),s._v(" 字段转换传递至 "),n("code",[s._v("grantsMap")]),s._v(" 用于后续的计算。源码如下：")]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 挂载流程权限配置")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initGrants")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("grantsMap "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("grants "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("code",[s._v("initGrants")]),s._v(" 会分别在表单初始化时、"),n("code",[s._v("grants")]),s._v(" 变化时、表单动态渲染时触发。这是很好的突破口，我们仅仅需要改写此处的 "),n("code",[s._v("initGrants")]),s._v(" 函数即可，将 "),n("code",[s._v("grantsMap")]),s._v(" 的来源改成全局状态对象，并根据自身的 "),n("code",[s._v("code")]),s._v(" 获取指定的权限配置。")]),s._v(" "),n("p",[n("img",{attrs:{src:a(524),alt:"Global Grants"}})]),s._v(" "),n("div",{staticClass:"language-js line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-js"}},[n("code",[n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Vue "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'vue'")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" Sahara "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'@ipeople/sahara'")]),s._v("\n\nVue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("use")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Sahara"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 请求、转换、存储权限信息至全局状态")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" globalGrants "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("fetchGrants")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("then")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("formatGrants"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 拓展 i-form-x")]),s._v("\nVue"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("component")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Sahara"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Form"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("X")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  mixins"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("Sahara"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Form"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),n("span",{pre:!0,attrs:{class:"token constant"}},[s._v("X")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n\n  methods"),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token function"}},[s._v("initGrants")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("grantsMap "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" globalGrants"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),n("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("code"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])])])}),[],!1,null,null,null);t.default=e.exports}}]);